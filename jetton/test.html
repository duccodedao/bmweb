<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App Full Features Demo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }
        h1, h2 {
            color: var(--tg-theme-link-color, #007bff);
        }
        .section {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s, opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background-color: var(--tg-theme-hint-color, #cccccc);
            cursor: not-allowed;
        }
        p {
            margin-bottom: 10px;
        }
        textarea, input[type="text"] {
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 4px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #initDataDisplay {
            word-break: break-all;
            background-color: var(--tg-theme-hint-color, #e9e9e9);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h1>Telegram Web App Demo</h1>

    <div class="section">
        <h2>I. Thông tin Web App</h2>
        <p><strong>Version:</strong> <span id="appVersion"></span></p>
        <p><strong>Platform:</strong> <span id="appPlatform"></span></p>
        <p><strong>Color Scheme:</strong> <span id="appColorScheme"></span></p>
        <p><strong>Is Expanded:</strong> <span id="appIsExpanded"></span></p>
        <p><strong>Viewport Height:</strong> <span id="appViewportHeight"></span>px</p>
        <p><strong>Viewport Stable Height:</strong> <span id="appViewportStableHeight"></span>px</p>
        <p><strong>Header Color:</strong> <span id="appHeaderColor"></span></p>
        <p><strong>Background Color:</strong> <span id="appBackgroundColor"></span></p>
        <p><strong>Theme Parameters:</strong></p>
        <pre id="appThemeParams" style="white-space: pre-wrap; font-size: 0.9em;"></pre>
        <p><strong>Init Data (Unsafe):</strong></p>
        <pre id="initDataDisplay"></pre>
    </div>

    <div class="section">
        <h2>II. Điều khiển UI & Tương tác</h2>
        <h3>Main Button</h3>
        <button onclick="toggleMainButton()">Toggle Main Button</button>
        <button onclick="setMainButtonText()">Set Main Button Text</button>
        <button onclick="showMainButtonProgress()">Show Main Button Progress</button>
        <button onclick="hideMainButtonProgress()">Hide Main Button Progress</button>
        <button onclick="disableMainButton()">Disable Main Button</button>
        <button onclick="enableMainButton()">Enable Main Button</button>

        <h3>Back Button</h3>
        <button onclick="toggleBackButton()">Toggle Back Button</button>

        <h3>Haptic Feedback</h3>
        <button onclick="impactOccurred()">Impact Occurred</button>
        <button onclick="notificationOccurred('success')">Notification Success</button>
        <button onclick="notificationOccurred('warning')">Notification Warning</button>
        <button onclick="notificationOccurred('error')">Notification Error</button>
        <button onclick="selectionChanged()">Selection Changed</button>

        <h3>Color Settings</h3>
        <button onclick="changeHeaderColor()">Change Header Color (Blue)</button>
        <button onclick="changeBackgroundColor()">Change Background Color (Green)</button>
        <button onclick="resetColors()">Reset Colors</button>

        <h3>Closing Confirmation</h3>
        <p>Closing confirmation: <span id="closingConfirmationStatus"></span></p>
        <button onclick="enableClosingConfirmation()">Enable Closing Confirmation</button>
        <button onclick="disableClosingConfirmation()">Disable Closing Confirmation</button>
    </div>

    <div class="section">
        <h2>III. Giao tiếp với Bot & Telegram</h2>
        <h3>Gửi dữ liệu về Bot</h3>
        <input type="text" id="dataToSend" placeholder="Enter data to send to bot">
        <button onclick="sendDataToBot()">Send Data</button>

        <h3>Mở liên kết</h3>
        <button onclick="openTelegramLink()">Open Telegram Link (t.me/telegram)</button>
        <button onclick="openExternalLink()">Open External Link (google.com)</button>
        <button onclick="openInvoice()">Open Invoice (Example)</button>

        <h3>Popup & Alerts</h3>
        <button onclick="showAlertMessage()">Show Alert</button>
        <button onclick="showConfirmMessage()">Show Confirm</button>
        <button onclick="showCustomPopup()">Show Custom Popup</button>

        <h3>Yêu cầu quyền</h3>
        <button onclick="requestWriteAccess()">Request Write Access</button>
        <button onclick="requestContact()">Request Contact</button>
        <button onclick="requestLocation()">Request Location</button>
        <button onclick="readClipboard()">Read Clipboard</button>
        <button onclick="scanQrCode()">Scan QR Code</button>

        <h3>Đóng Mini App</h3>
        <button onclick="closeWebApp()">Close Web App</button>
        <button onclick="expandWebApp()">Expand Web App</button>
    </div>

    <div class="section">
        <h2>IV. Sự kiện (Events)</h2>
        <p>Kiểm tra console log để xem các sự kiện được kích hoạt.</p>
        <textarea id="eventLog" rows="5" readonly style="width: 100%;"></textarea>
    </div>

    <script>
        const webApp = window.Telegram.WebApp;
        const mainButton = webApp.MainButton;
        const backButton = webApp.BackButton;
        const haptic = webApp.HapticFeedback;
        const eventLog = document.getElementById('eventLog');

        function logEvent(message) {
            const now = new Date().toLocaleTimeString();
            eventLog.value += `[${now}] ${message}\n`;
            eventLog.scrollTop = eventLog.scrollHeight;
        }

        // --- I. Thông tin Web App ---
        function displayWebAppInfo() {
            document.getElementById('appVersion').textContent = webApp.version;
            document.getElementById('appPlatform').textContent = webApp.platform;
            document.getElementById('appColorScheme').textContent = webApp.colorScheme;
            document.getElementById('appIsExpanded').textContent = webApp.isExpanded ? 'Yes' : 'No';
            document.getElementById('appViewportHeight').textContent = webApp.viewportHeight;
            document.getElementById('appViewportStableHeight').textContent = webApp.viewportStableHeight;
            document.getElementById('appHeaderColor').textContent = webApp.headerColor;
            document.getElementById('appBackgroundColor').textContent = webApp.backgroundColor;
            document.getElementById('appThemeParams').textContent = JSON.stringify(webApp.themeParams, null, 2);
            document.getElementById('initDataDisplay').textContent = JSON.stringify(webApp.initDataUnsafe, null, 2);
            document.getElementById('closingConfirmationStatus').textContent = webApp.isClosingConfirmationEnabled ? 'Enabled' : 'Disabled';
        }

        // --- II. Điều khiển UI & Tương tác ---

        // Main Button
        let isMainButtonVisible = false;
        function toggleMainButton() {
            if (isMainButtonVisible) {
                mainButton.hide();
            } else {
                mainButton.setText('Buy Now!');
                mainButton.show();
            }
            isMainButtonVisible = !isMainButtonVisible;
            logEvent(`Main Button visibility toggled to ${isMainButtonVisible}`);
        }

        function setMainButtonText() {
            mainButton.setText(`Random Text: ${Math.random().toFixed(2)}`);
            if (!mainButton.isVisible) {
                mainButton.show();
                isMainButtonVisible = true;
            }
            logEvent('Main Button text set.');
        }

        function showMainButtonProgress() {
            mainButton.showProgress();
            logEvent('Main Button progress shown.');
        }

        function hideMainButtonProgress() {
            mainButton.hideProgress();
            logEvent('Main Button progress hidden.');
        }

        function disableMainButton() {
            mainButton.disable();
            logEvent('Main Button disabled.');
        }

        function enableMainButton() {
            mainButton.enable();
            logEvent('Main Button enabled.');
        }

        // Back Button
        let isBackButtonVisible = false;
        function toggleBackButton() {
            if (isBackButtonVisible) {
                backButton.hide();
            } else {
                backButton.show();
            }
            isBackButtonVisible = !isBackButtonVisible;
            logEvent(`Back Button visibility toggled to ${isBackButtonVisible}`);
        }

        // Haptic Feedback
        function impactOccurred() {
            haptic.impactOccurred('light'); // 'light', 'medium', 'heavy', 'rigid', 'soft'
            logEvent('Impact haptic feedback triggered.');
        }

        function notificationOccurred(type) {
            haptic.notificationOccurred(type); // 'success', 'warning', 'error'
            logEvent(`Notification haptic feedback triggered: ${type}.`);
        }

        function selectionChanged() {
            haptic.selectionChanged();
            logEvent('Selection haptic feedback triggered.');
        }

        // Color Settings
        function changeHeaderColor() {
            webApp.setHeaderColor('#0056b3'); // Blue
            logEvent('Header color changed.');
            displayWebAppInfo(); // Update display
        }

        function changeBackgroundColor() {
            webApp.setBackgroundColor('#28a745'); // Green
            logEvent('Background color changed.');
            displayWebAppInfo(); // Update display
        }

        function resetColors() {
            webApp.setHeaderColor('bg_color'); // Reset to default background color
            webApp.setBackgroundColor('bg_color'); // Reset to default background color
            logEvent('Colors reset to default.');
            // Re-fetch theme params if needed to confirm reset, or just update UI based on default.
            // For true reset, you'd reload or use a persistent state.
            // This just resets to a theme param.
            displayWebAppInfo();
        }

        // Closing Confirmation
        function enableClosingConfirmation() {
            webApp.enableClosingConfirmation();
            logEvent('Closing confirmation enabled.');
            document.getElementById('closingConfirmationStatus').textContent = 'Enabled';
        }

        function disableClosingConfirmation() {
            webApp.disableClosingConfirmation();
            logEvent('Closing confirmation disabled.');
            document.getElementById('closingConfirmationStatus').textContent = 'Disabled';
        }

        // --- III. Giao tiếp với Bot & Telegram ---

        function sendDataToBot() {
            const data = document.getElementById('dataToSend').value;
            if (data) {
                webApp.sendData(data);
                logEvent(`Data sent to bot: "${data}"`);
            } else {
                logEvent('Please enter data to send.');
            }
        }

        function openTelegramLink() {
            const link = 'https://t.me/telegram'; // Example Telegram link
            webApp.openTelegramLink(link);
            logEvent(`Opened Telegram link: ${link}`);
        }

        function openExternalLink() {
            const link = 'https://www.google.com'; // Example external link
            webApp.openLink(link);
            logEvent(`Opened external link: ${link}`);
        }

        function openInvoice() {
            // Replace with a real invoice URL from your bot
            const invoiceUrl = 'https://t.me/iv?url=https%3A%2F%2Fpay.yandex.ru%2Fpayments%2F...'; // This is an example, replace with a real one
            if (webApp.openInvoice) {
                webApp.openInvoice(invoiceUrl, (status) => {
                    logEvent(`Invoice status: ${status}`);
                    if (status === 'paid') {
                        showAlertMessage('Invoice paid successfully!');
                    } else if (status === 'cancelled') {
                        showAlertMessage('Invoice cancelled.');
                    } else if (status === 'failed') {
                        showAlertMessage('Invoice failed.');
                    }
                });
                logEvent(`Opened invoice: ${invoiceUrl}`);
            } else {
                logEvent('openInvoice is not supported in this Web App version.');
                showAlertMessage('openInvoice is not supported in this Web App version.');
            }
        }


        function showAlertMessage() {
            webApp.showAlert('This is an alert message from your Web App!', () => {
                logEvent('Alert dismissed.');
            });
            logEvent('Alert shown.');
        }

        function showConfirmMessage() {
            webApp.showConfirm('Do you want to proceed with this action?', (confirmed) => {
                logEvent(`Confirm dialog result: ${confirmed}`);
                if (confirmed) {
                    showAlertMessage('You confirmed!');
                } else {
                    showAlertMessage('You cancelled!');
                }
            });
            logEvent('Confirm dialog shown.');
        }

        function showCustomPopup() {
            webApp.showPopup({
                title: 'Custom Popup',
                message: 'This is a customizable popup with multiple buttons.',
                buttons: [
                    { id: 'ok', type: 'ok' },
                    { id: 'cancel', type: 'cancel' },
                    { id: 'destructive', type: 'destructive', text: 'Delete' },
                    { id: 'custom', type: 'default', text: 'Custom Button' }
                ]
            }, (buttonId) => {
                logEvent(`Popup button pressed: ${buttonId}`);
                showAlertMessage(`You pressed: ${buttonId}`);
            });
            logEvent('Custom popup shown.');
        }

        function requestWriteAccess() {
            webApp.requestWriteAccess((granted) => {
                logEvent(`Write access granted: ${granted}`);
                showAlertMessage(`Write access ${granted ? 'granted' : 'denied'}.`);
            });
            logEvent('Requested write access.');
        }

        function requestContact() {
            webApp.requestContact((granted) => {
                logEvent(`Contact access granted: ${granted}`);
                showAlertMessage(`Contact access ${granted ? 'granted' : 'denied'}.`);
            });
            logEvent('Requested contact.');
        }

        function requestLocation() {
            webApp.requestLocation((location) => {
                if (location) {
                    logEvent(`Location: Lat ${location.latitude}, Lon ${location.longitude}`);
                    showAlertMessage(`Location received: Lat ${location.latitude}, Lon ${location.longitude}`);
                } else {
                    logEvent('Location access denied or failed.');
                    showAlertMessage('Location access denied or failed.');
                }
            });
            logEvent('Requested location.');
        }

        function readClipboard() {
            if (webApp.readTextFromClipboard) {
                webApp.readTextFromClipboard((text) => {
                    if (text) {
                        logEvent(`Clipboard content: ${text}`);
                        showAlertMessage(`Clipboard content: "${text}"`);
                    } else {
                        logEvent('Clipboard is empty or access denied.');
                        showAlertMessage('Clipboard is empty or access denied.');
                    }
                });
                logEvent('Requested clipboard content.');
            } else {
                logEvent('readTextFromClipboard is not supported in this Web App version.');
                showAlertMessage('readTextFromClipboard is not supported in this Web App version.');
            }
        }

        function scanQrCode() {
            if (webApp.scanQrCode) {
                webApp.scanQrCode((text) => {
                    if (text) {
                        logEvent(`QR Code scanned: ${text}`);
                        showAlertMessage(`QR Code scanned: ${text}`);
                    } else {
                        logEvent('QR Code scan cancelled.');
                    }
                });
                logEvent('Opened QR code scanner.');
            } else {
                logEvent('scanQrCode is not supported in this Web App version.');
                showAlertMessage('scanQrCode is not supported in this Web App version.');
            }
        }


        function closeWebApp() {
            webApp.close();
            logEvent('Web App closed.');
        }

        function expandWebApp() {
            webApp.expand();
            logEvent('Web App expanded to full screen.');
        }

        // --- IV. Sự kiện (Events) ---
        function setupEventListeners() {
            webApp.onEvent('mainButtonClicked', () => {
                logEvent('Event: Main Button Clicked!');
                showAlertMessage('Main Button was clicked!');
            });

            webApp.onEvent('backButtonClicked', () => {
                logEvent('Event: Back Button Clicked!');
                showAlertMessage('Back Button was clicked!');
            });

            webApp.onEvent('viewportChanged', () => {
                logEvent(`Event: Viewport Changed! New height: ${webApp.viewportHeight}, Stable: ${webApp.viewportStableHeight}`);
                document.getElementById('appViewportHeight').textContent = webApp.viewportHeight;
                document.getElementById('appViewportStableHeight').textContent = webApp.viewportStableHeight;
                document.getElementById('appIsExpanded').textContent = webApp.isExpanded ? 'Yes' : 'No';
            });

            webApp.onEvent('themeChanged', () => {
                logEvent('Event: Theme Changed!');
                displayWebAppInfo(); // Re-display info to update colors
            });

            webApp.onEvent('closingConfirmationChanged', () => {
                logEvent('Event: Closing Confirmation Changed!');
                document.getElementById('closingConfirmationStatus').textContent = webApp.isClosingConfirmationEnabled ? 'Enabled' : 'Disabled';
            });

            webApp.onEvent('qrTextReceived', (data) => {
                logEvent(`Event: QR Text Received! Data: ${data.data}`);
                showAlertMessage(`QR Text Received: ${data.data}`);
                // In a real app, you'd process the QR data here
            });

            // You can add more event listeners here as needed
            // webApp.onEvent('invoiceClosed', (data) => { ... });
            // webApp.onEvent('clipboardTextReceived', (data) => { ... });
            // webApp.onEvent('writeAccessRequested', (data) => { ... });
            // webApp.onEvent('contactRequested', (data) => { ... });
            // webApp.onEvent('locationRequested', (data) => { ... });
        }


        // Initialize on Telegram Web App ready
        webApp.ready();
        displayWebAppInfo();
        setupEventListeners();

        // Optionally, make main button visible on load
        // mainButton.setText('Initial Button');
        // mainButton.show();
        // isMainButtonVisible = true;

        // Apply theme parameters to CSS variables
        function applyThemeParams() {
            if (webApp.themeParams) {
                for (const key in webApp.themeParams) {
                    document.documentElement.style.setProperty(`--tg-theme-${key}`, webApp.themeParams[key]);
                }
            }
        }

        webApp.onEvent('themeChanged', applyThemeParams);
        applyThemeParams(); // Apply initial theme
    </script>
</body>
</html>
